---
layout: 8html-posts
title: 高效转移网站和数据库到其他服务器
author: caiguanhao
category: tech
tags: Server
description: 网站要搬家，通常的做法是从A网站下载所有文件然后再上传到B网站，或者在A网站上打包了再下载，再上传到B网站解压。而目前最好的方法是SSH登录服务器用rsync命令。
---
网站要搬家，通常的做法是从A网站下载所有文件然后再上传到B网站，或者在A网站上打包了再下载，再上传到B网站解压。这类方法有3台电脑直接参与了整个过程，而在中国，很遗憾的是，普通居民的所谓宽带的上传速度很慢，如果这样做很没有效率。

目前最好的方法是用SSH登录A服务器，然后将A服务器上的文件和数据同步到B服务器上，这样只直接涉及两台服务器，而且我的两台服务器的网络不错，它们之间的传输数度可以有2~3M/s。首先生成自己电脑的公钥，在A服务器导入，然后SSH登入A服务器，再用ssh-keygen生成A服务器的公钥，在B服务器导入，使得A服务器能用SSH登入B服务器。

### 复制文件

在 A 服务器上使用 rsync 命令

``rsync -avzP /path/to/source/ user@remote:/path/to/destination/``

a 为归档模式，即复制文件保留修改日期，权限等信息，v 显示详细信息，z 为压缩传输，p 开启断点续传和显示进度，第一个路径是本地路径，第二个是远程服务器地址。通常情况下，如果远程路径是不存在的，rsync可以自动创建一层文件夹，如果多层文件夹都是不存在的，则会出现文件不存在的错误，所以如果远程路径是多层不存在的应该先另外创建。

### 复制数据

网站文件复制好了，轮到复制数据库。MySQL可以通过命令导入和导出，利用这点，让A服务器直接将导出的数据直接传到B服务器导入，这样就免去了生成文件和导入文件的步骤了。如果数据库很大，这招更好用。

``mysqldump -u user -p'password' A服务器上的数据库名 | ssh user@remote mysql -u user -p'password' B服务器上的数据库名``

执行命令所费时间大部分只是两台服务器之间的传输速度，一个40多M的数据库复制用了约20秒：

<img src="/uploads/2012/07/ssh-mysql.png" width="585" height="389" />
